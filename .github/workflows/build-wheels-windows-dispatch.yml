name: windows-dispatch

on:
  # schedule:
  #    - cron: '0 0 * * 0,3'
  workflow_dispatch:
    inputs:
      IDF_branch:
        description: >
          Wheels will be built for this branch. This will
          be ignored if specific packages are listed bellow.
        type: string
        required: false
        default: 'master'
      packages:
        description: >
          Generate wheels for given packages separated by space.
          Requirement specifiers can be used.
          For example esptool~=4.5 esp-coredump~=1.2
        type: string
        required: false
  workflow_call:
    inputs:
      IDF_branch:
        description: >
          Wheels will be built for this branch. This will
          be ignored if specific packages are listed bellow.
        type: string
        required: false
        default: 'master'
      packages:
        description: >
          Wheels will be built for this branch. This will
          be ignored if specific packages are listed bellow.
          Generate wheels for given packages separated by space.
          Requirement specifiers can be used.
          For example esptool~=4.5 esp-coredump~=1.2
        type: string
        required: false

jobs:
  build-python-wheels:
    name: Build Python Wheels for windows-latest
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8.10', '3.9.13', '3.10.2', '3.11.4']
    steps:
      - name: Prepare package list
        shell: bash
        if: ${{ inputs.packages }}
        run: |
          echo "input packages: ${{ inputs.packages }}"
          PACKAGES=$(echo "${{ inputs.packages }}" |
                     sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/\([^[:space:]]\{1,\}\)/"\1"/g;s/[[:space:]]\{1,\}/,/g')
          echo "packages=$PACKAGES" >> $GITHUB_ENV
          echo "output packages: $PACKAGES"
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install stable Rust with clippy and rustfmt
        uses: actions-rs/toolchain@v1
        with:
         profile: default
         toolchain: stable
         components: rustfmt, clippy
      - name: Rust version
        run: rustc --version
      - name: Prepare download folder
        shell: pwsh
        run: mkdir download
      - name: Install build dependencies
        shell: pwsh
        run: python3 -m pip install wheel
      - name: Get python3 version
        shell: pwsh
        run: python3 --version
      - name: Get branch name
        shell: bash
        run: |
          echo INPUT=${{ github.event.inputs.IDF_branch }}
          if [[ $INPUT == "" ]]; then
            echo "IDF_branch=main" >> $GITHUB_ENV
          else
            echo IDF_branch=${{ github.event.inputs.IDF_branch }} >> $GITHUB_ENV
          fi
      - name: Build wheels for IDF ${{ env.IDF_branch }} branch
        env:
          PIP_EXTRA_INDEX_URL: "https://www.piwheels.org/simple"
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if ( "${{ inputs.packages }}" ) {
            .\Build-Wheels.ps1  -Branch ${{ env.IDF_branch }} -Arch "${{ matrix.ARCH }}" -NoReq -CompileWheels @(${{ env.packages }})
          } else {
            # Cython==3.0.0 breaks the build of gevent. The build environment from https://github.com/gevent/gevent/blob/1.5.0/pyproject.toml
            # must be patched with "cython<3"
            .\Build-Wheels.ps1  -Branch ${{ env.IDF_branch }} -BuildEnv @("setuptools", "wheel", "cython<3", "cffi") -CompileWheels @("gevent==1.5.0")

            # python-pkcs11 can't be build on Python 3.10 and above (3.10.2 works) https://github.com/danni/python-pkcs11/issues/159
            .\Build-Wheels.ps1  -Branch ${{ env.IDF_branch }} -CompileWheels @("cryptography", "windows-curses", "python-pkcs11;python_version<'3.11'")
          }
      - name: Test wheels by installation
        shell: pwsh
        run: |
          if ( "${{ inputs.packages }}" ) {
            .\Test-Wheels.ps1 -Branch ${{ env.IDF_branch }} -Arch "${{ matrix.ARCH }}" -TestWheels @(${{ env.packages }})
          } else {
            .\Test-Wheels.ps1 -Branch ${{ env.IDF_branch }} -Arch "${{ matrix.ARCH }}"
          }
      - name: Upload Release Asset To test s3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          AWS_BUCKET: ${{ secrets.DL_BUCKET }}
          PREFIX: 'pypi'
        shell: bash
        run: |
          chmod +x Upload-Wheels.sh
          pip3 install boto3
          ./Upload-Wheels.sh $AWS_BUCKET
          python3 create_index_pages.py $AWS_BUCKET
      - name: Drop AWS cache
        id: invalidate-index-cache
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_CACHE_INVALIDATION }} --paths "/pypi/*"
