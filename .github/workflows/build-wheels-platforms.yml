name: platforms-dispatches

on:
  schedule:
    - cron: '0 0 * * 0,3'
  workflow_dispatch:

env:
  GH_TOKEN : ${{ secrets.GITHUB_TOKEN }}

jobs:
  get-supported-versions:
    name: Get Supported Versions
    uses: ./.github/workflows/get-supported-versions.yml
    secrets: inherit

  build-wheels:
    needs: get-supported-versions
    name: Build for ${{ matrix.os }} (Python ${{matrix.python-version}})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        os: # Platform names for identification
          - Windows
          - Linux x86_64
          - macOS Intel
          - macOS ARM
          - Linux ARM64
          - Linux ARMv7
        include:
          - os: Windows
            runner: windows-latest
          - os: Linux x86_64
            runner: ubuntu-latest
          - os: macOS Intel
            runner: macos-15-intel
          - os: macOS ARM
            runner: macos-latest
          - os: Linux ARM64
            runner: ubuntu-24.04-arm
          - os: Linux ARMv7
            runner: linux-armv7-self-hosted  # Self-hosted ARMv7 runner
            CONTAINER: python:${{ needs.get-supported-versions.outputs.oldest_supported_python }}-bookworm
        python-version: ['${{ needs.get-supported-versions.outputs.oldest_supported_python }}']

    # Use python container on ARM
    container: ${{ matrix.CONTAINER }}

    steps:
      - name: OS info
        if: matrix.os != 'Windows'
        run: |
          echo "Operating System: ${{ runner.os }}"
          echo "Architecture: $(uname -m)"
      - name: OS info
        if: matrix.os == 'Windows'
        run: |
          echo "Operating System: ${{ runner.os }}"
          echo "Architecture: $env:PROCESSOR_ARCHITECTURE"


      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set IDF version environment variables
        run: |
          echo "MIN_IDF_MAJOR_VERSION=${{ needs.get-supported-versions.outputs.min_idf_major_version }}" >> $GITHUB_ENV
          echo "MIN_IDF_MINOR_VERSION=${{ needs.get-supported-versions.outputs.min_idf_minor_version }}" >> $GITHUB_ENV
          echo "Setting MIN_IDF_MAJOR_VERSION=${{ needs.get-supported-versions.outputs.min_idf_major_version }}, MIN_IDF_MINOR_VERSION=${{ needs.get-supported-versions.outputs.min_idf_minor_version }}"

      - name: Setup Python
        # Skip setting python on ARM because of missing compatibility: https://github.com/actions/setup-python/issues/108
        if: matrix.os != 'Linux ARMv7'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}


      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r build_requirements.txt


      - name: Get Tools versions
        run: |
          python --version
          pip show pip setuptools


      - name: Install additional OS dependencies - Ubuntu
        if: matrix.os == 'Linux x86_64'
        run: os_dependencies/ubuntu.sh

      - name: Install additional OS dependencies - MacOS
        if: matrix.os == 'macOS ARM' || matrix.os == 'macOS Intel'
        run: os_dependencies/macos.sh

      - name: Install additional OS dependencies - Linux ARM
        if: matrix.os == 'Linux ARMv7' || matrix.os == 'Linux ARM64'
        run: os_dependencies/linux_arm.sh

      - name: Install additional OS dependencies - Windows
        if: matrix.os == 'Windows'
        run: powershell -ExecutionPolicy Bypass -File os_dependencies/windows.ps1


      - name: Build wheels for IDF
        if: matrix.os != 'Windows'
        run: |
          # Source Rust environment for ARMv7
          if [ "${{ matrix.os }}" = "Linux ARMv7" ]; then
            . $HOME/.cargo/env
          fi

          # Set ARCHFLAGS for macOS to prevent universal2 wheels
          if [ "${{ matrix.os }}" = "macOS ARM" ]; then
            export ARCHFLAGS="-arch arm64"
          elif [ "${{ matrix.os }}" = "macOS Intel" ]; then
            export ARCHFLAGS="-arch x86_64"
          fi

          python build_wheels.py

      - name: Build wheels for IDF - Windows
        if: matrix.os == 'Windows'
        run: python build_wheels.py

      - name: Upload artifacts of downloaded_wheels directory
        uses: actions/upload-artifact@v4
        with:
          name: wheels-download-directory-${{ matrix.runner}}-${{ matrix.python-version }}
          path: ./downloaded_wheels
          retention-days: 1

      - name: Upload artifacts of Python version dependent wheels
        uses: actions/upload-artifact@v4
        with:
          name: dependent_requirements_${{ matrix.runner}}
          path: ./dependent_requirements.txt
          retention-days: 1


  build-python-version-dependent-wheels:
    needs: [get-supported-versions, build-wheels]
    name: Build Python version dependendent wheels for IDF
    uses: ./.github/workflows/build-wheels-python-dependent.yml
    with:
      supported_python_versions: ${{ needs.get-supported-versions.outputs.supported_python }}
      oldest_supported_python: ${{ needs.get-supported-versions.outputs.oldest_supported_python }}

  # Repair wheels for all platforms (Windows, macOS, Linux)
  repair-wheels:
    needs: [build-wheels, build-python-version-dependent-wheels]
    name: Repair wheels
    uses: ./.github/workflows/wheels-repair.yml

  # TODO Uncomment this when we are ready to upload the wheels
  #upload-python-wheels:
  #  needs: [repair-manylinux-wheels]  # Changed to depend on repaired wheels
  #  name: Upload Python wheels
  #  uses: ./.github/workflows/upload-python-wheels.yml
  #  secrets: inherit
